#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
c( pred1)
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1
}
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
obs
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
#   c(RMSE(obs, pred1))
dim(obs)
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
#   c(RMSE(obs, pred1))
print( dim(obs))
print(dim(pred1))
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
#   c(RMSE(obs, pred1))
print( dim(obs))
# print(dim(pred1))
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
#   c(RMSE(obs, pred1))
print( length(obs))
# print(dim(pred1))
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
#   c(RMSE(obs, pred1))
print( dim(obs))
print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
#   c(RMSE(obs, pred1))
print( dim(test))
print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
obs
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
class(pred1)
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred[1]
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1[1]
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1[[1]]
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
class(pred1)
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
class(pred1[,1])
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1[,1]
#   c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
fitLM(1)
RMSE <- function(obs, pred) {
sqrt(mean((obs - pred[,1])^2))
}
fitLM <- function(i) {
train <- traffic[index != i, ]
train[, siteRef := factor(siteRef, levels=sites)]
test <- traffic[index == i, ]
test[, siteRef := factor(siteRef, levels=sites)]
fit1 <- glm4(scount ~ class, data=train, sparse=TRUE)
coef1 <- coef(fit1)
rm(fit1)
#    fit2 <- glm4(scount ~ class + siteRef, data=train, sparse=TRUE)
#    coef2 <- coef(fit2)
#    rm(fit2)
pred1 <- model.Matrix(scount ~ class,
data=test, sparse=TRUE) %*%
coef1
#   pred2 <- model.Matrix(scount ~ class + siteRef,
#                         data=test, sparse=TRUE) %*%
#                coef2
obs <- test$scount
pred1[,1]
c(RMSE(obs, pred1))
#  print( dim(test))
# print(dim(pred1))
}
system.time({
rmse<- do.call(rbind,mclapply(1:10,function(i) fitLM(i)))
})
rmse
model.Matrix(scount ~ class,
data=traffic, sparse=TRUE)
model.Matrix(scount ~ class,
data=test, sparse=TRUE)
model.Matrix(scount ~ class,
data=traffic, sparse=TRUE)
model.Matrix(scount ~ class+siteRef,
data=traffic, sparse=TRUE)
